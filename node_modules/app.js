require('dotenv').config();
const express = require('express');
const cors = require('cors');
const mysql = require('mysql2');
const app = express();

// -----------------------
// Middleware
// -----------------------
app.use(cors());
app.use(express.json());
app.use(express.static('../frontend')); // serve frontend files

// -----------------------
// MySQL connection
// -----------------------
const db = mysql.createConnection({
  host: process.env.DB_HOST || 'localhost',
  user: process.env.DB_USER || 'root',
  password: process.env.DB_PASSWORD || '',
  database: process.env.DB_NAME || 'disaster_alert'
});

db.connect(err => {
  if(err) console.log("DB Connection Error:", err);
  else console.log("Connected to MySQL");
});

// -----------------------
// Routes
// -----------------------

// Test route
app.get('/', (req,res) => res.send("DisasterAlert Backend Running!"));

// Create new emergency
app.post('/api/emergencies', (req,res) => {
  const {title, description, location, category} = req.body;
  if(!title || !description || !location || !category){
    return res.json({success:false, message:"All fields are required"});
  }
  db.query(
    'INSERT INTO emergencies(title,description,location,category,status) VALUES(?,?,?,?,?)',
    [title, description, location, category, 'Reported'],
    (err,result) => {
      if(err) return res.json({success:false,message:"DB error"});
      res.json({success:true,message:"Emergency reported!"});
    }
  );
});

// Get all emergencies
app.get('/api/emergencies', (req,res) => {
  db.query('SELECT * FROM emergencies ORDER BY created_at DESC', [], (err,result)=>{
    if(err) return res.json({success:false,message:"DB error"});
    res.json(result);
  });
});

// Update emergency status
app.patch('/api/emergencies/:id/status', (req,res) => {
  const {status} = req.body;
  const id = req.params.id;
  if(!status) return res.json({success:false,message:"Status is required"});
  db.query('UPDATE emergencies SET status=? WHERE id=?',[status,id], (err,result)=>{
    if(err) return res.json({success:false,message:"DB error"});
    res.json({success:true,message:"Status updated"});
  });
});

// -----------------------
// Start server
// -----------------------
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`Server running on port ${PORT}`));
